generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Core Entities ---

model Organization {
  id             String          @id @default(uuid())
  name           String
  slug           String?         @unique @default(cuid())
  plan           String          @default("free")
  status         String          @default("active")
  maxUsers       Int             @default(5)
  maxProjects    Int             @default(10)
  timezone       String          @default("UTC")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  departments    Department[]
  users          User[]
  projects       Project[]
  tags           Tag[]
  kpiDefinitions KpiDefinition[]
  dailyReports   DailyReport[]
  domains        String[]        @default([]) // e.g. ["softserve.com", "google.com"]
  invites        Invite[]
  
  // AI Advisory Board Settings
  settings       Json?           // Global work days/hours, defaults
  aiPolicy       Json?           // AI behavior settings (tone, frequency)
  
  // New Relations
  teams          Team[]
  jobRoles       JobRole[]
  goals          Goal[]
  setup          OrganizationSetup?
}

model Invite {
  id          String   @id @default(uuid())
  email       String
  token       String   @unique
  
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  inviterId   String
  inviter     User     @relation("UserInvites", fields: [inviterId], references: [id])
  
  role        String?  // e.g. "EMPLOYEE", "MANAGER"
  
  expiresAt   DateTime
  status      InviteStatus @default(PENDING)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([email])
  @@index([token])
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

model Department {
  id        String   @id @default(uuid())
  name      String
  
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Link to archetype template (optional for custom departments)
  archetypeId String?
  archetype   DepartmentArchetype? @relation(fields: [archetypeId], references: [id])
  
  managerId String?
  hrId      String?
  
  users     User[]
  projects  Project[]
  teams     Team[]
  goals     Goal[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("departments")
}

// Legacy Enum - Keeping for migration safety, but moving to Role model
enum LegacyRole {
  EMPLOYEE
  MANAGER
  HR
  ADMIN
  OWNER
}

enum Language {
  UK
  EN
}

enum UserStatus {
  ACTIVE
  PENDING
  BLOCKED
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  googleId     String?  @unique
  passwordHash String?
  fullName     String
  timezone     String   @default("UTC")
  language     Language @default(UK)
  status       UserStatus @default(ACTIVE)
  orgId        String
  org          Organization @relation(fields: [orgId], references: [id])
  deptId       String?
  department   Department? @relation(fields: [deptId], references: [id])
  
  // Roles & Access
  roles        UserRole[]
  
  // Work Role Archetype (job function, not access control)
  roleArchetypeId String?
  roleArchetype   RoleArchetype? @relation("UserRoleArchetype", fields: [roleArchetypeId], references: [id])
  
  // Soft Delete
  deletedAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  dailyReports DailyReport[]
  activities   Activity[]
  projectsOwned Project[]
  helpRequestsAssigned HelpRequest[] @relation("HelpRequestsAssigned")
  dailyReportReactions DailyReportReaction[]
  dailyReportComments  DailyReportComment[]
  dailyPlans           DailyPlan[]           @relation("UserDailyPlans")
  threeBlocks          ThreeBlocks[]

  // User Settings & Admin Module
  profile         UserProfile?
  preferences     UserPreferences?
  integrations    Integration[]
  kpis            UserKPI[]
  workdaySettings WorkdaySettings?
  artifacts       Artifact[]
  userProjects    UserProject[]
  sentInvites     Invite[]      @relation("UserInvites")

  // AI Advisory Board Fields
  managerId       String?
  manager         User?         @relation("UserManager", fields: [managerId], references: [id])
  directReports   User[]        @relation("UserManager")

  teamId          String?
  team            Team?         @relation(fields: [teamId], references: [id])

  jobRoleId       String?
  jobRole         JobRole?      @relation(fields: [jobRoleId], references: [id])

  workSchedule    Json?         // { days: [1,2,3,4,5], start: "09:00", end: "18:00", timezone: "UTC" }

  // Wizard State
  userWizardCompleted   Boolean @default(false)
  userWizardSkipped     Boolean @default(false)
  userCurrentStep       Int     @default(0)       // 0-4

  // New Relations
  workdays        Workday[]
  goals           Goal[]        @relation("UserGoals")
  aiAdvice        AIAdvice[]
  workdaySummaries WorkdaySummary[]
}

// --- Access Control (RBAC) ---

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "EMPLOYEE", "MANAGER", "ADMIN"
  description String?
  scopes      String[] // e.g., ["team.read", "project.create"]
  isSystem    Boolean  @default(false)
  
  users       UserRole[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  assignedBy String?
  createdAt  DateTime @default(now())
  
  @@unique([userId, roleId])
}

model AccessLog {
  id          String   @id @default(uuid())
  requesterId String
  targetId    String
  reason      String
  scopes      String[]
  grantedAt   DateTime @default(now())
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

// --- User Profile Layers ---

model UserProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  jobTitle    String?
  department  String?
  bio         String?
  avatarUrl   String?
  phone       String?
  
  // New fields
  resumeUrl       String?
  roleDescription String?
  
  updatedAt   DateTime @updatedAt
}

model Artifact {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        ArtifactType
  layer       ProfileLayer
  
  title       String
  content     String?  // Text content or URL
  metadata    Json?
  
  version     Int      @default(1)
  isCurrent   Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  createdBy   String?
}

enum ArtifactType {
  RESUME
  JOB_DESCRIPTION
  ROLE_DESCRIPTION
  HATS_LIST
  ONBOARDING_DOC
  OTHER
}

enum ProfileLayer {
  OFFICIAL
  ACTUAL
  INSTRUMENTAL
}

// --- Extended User Settings ---

model WorkdaySettings {
  id           String   @id @default(uuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  timezone     String   @default("Europe/Kyiv")
  start        String   @default("09:00")
  end          String   @default("18:00")
  breakMinutes Int      @default(60)
  workDays     Int[]    @default([1, 2, 3, 4, 5])
  
  updatedAt    DateTime @updatedAt
}

model UserPreferences {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  language              Language @default(UK)
  timezone              String   @default("Europe/Kyiv")
  workDayStart          String   @default("09:00")
  workDayEnd            String   @default("18:00")
  isAutoBookFocus       Boolean  @default(false)
  privacyAggregatedOnly Boolean  @default(true)
  useMinimalisticDesign Boolean  @default(false)
  updatedAt             DateTime @updatedAt
}

// --- Integrations ---

enum IntegrationType {
  YAWARE
  GMAIL
  CALENDAR
  JIRA
}

model Integration {
  id          String          @id @default(uuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        IntegrationType
  credentials Json?
  settings    Json?
  isEnabled   Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([userId, type])
}

// --- KPI System ---

enum KpiPeriod {
  DAY
  WEEK
  MONTH
}

enum KpiSource {
  MANUAL
  INTEGRATION
}

enum KpiStatus {
  ACTIVE
  PENDING
  ARCHIVED
}

model KpiDefinition {
  id          String   @id @default(uuid())
  name        String
  unit        String
  period      KpiPeriod @default(WEEK)
  source      KpiSource @default(MANUAL)
  
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id])
  
  isSystem    Boolean  @default(false)
  
  assignments UserKPI[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserKPI {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  definitionId String
  definition   KpiDefinition @relation(fields: [definitionId], references: [id])
  
  targetValue  Float
  status       KpiStatus @default(ACTIVE)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// --- Project System ---

enum ProjectStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
}

enum ProjectType {
  ONGOING
  ONE_TIME
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)
  type        ProjectType   @default(ONGOING)
  
  deadline    DateTime?
  
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id])
  deptId      String?
  department  Department? @relation(fields: [deptId], references: [id])
  ownerId     String
  owner       User @relation(fields: [ownerId], references: [id])
  
  userAssignments UserProject[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserProject {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  role        String?  // "Owner", "Member"
  isPinned    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  
  @@unique([userId, projectId])
}

model Tag {
  id          String   @id @default(uuid())
  name        String
  color       String   @default("#808080")
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([orgId, name])
}

// --- Daily Report ---

enum ReportStatus {
  DRAFT
  PUBLISHED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum HelpStatus {
  OPEN
  IN_PROGRESS
  DONE
  OVERDUE
}

enum ReportVisibility {
  PUBLIC
  TEAM
  PRIVATE
}

enum LoadStatus {
  BALANCED
  OVERLOADED
  UNDERLOADED
}

model DailyReport {
  id          String   @id @default(uuid())
  date        DateTime @db.Date
  userId      String
  user        User @relation(fields: [userId], references: [id])
  
  orgId       String?
  org         Organization? @relation(fields: [orgId], references: [id])
  
  yesterdayBig    Json?
  yesterdayMedium Json?
  yesterdaySmall  Json?
  yesterdayNote   String?
  coveragePct     Int?
  
  todayBig        Json?
  todayMedium     Json?
  todaySmall      Json?
  todayNote       String?
  
  helpRequests    HelpRequest[]
  
  mood            Int?
  wellbeing       String?
  moodComment     String?
  
  status          ReportStatus @default(DRAFT)
  publishedAt     DateTime?
  
  // Team View Fields
  visibility      ReportVisibility @default(TEAM)
  loadStatus      LoadStatus       @default(BALANCED)
  loadManuallySet Boolean          @default(false)
  
  reactions       DailyReportReaction[]
  comments        DailyReportComment[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  activities      Activity[]
  kpis            DailyReportKPI[]
  
  @@unique([userId, date])
  @@index([orgId])
  @@index([orgId, date])
}

model DailyReportReaction {
  id        String      @id @default(uuid())
  reportId  String
  report    DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  emoji     String      // "ðŸ‘", "ðŸ‘", "ðŸ¤", "ðŸ’¡"
  
  createdAt DateTime    @default(now())
  
  @@unique([reportId, userId, emoji])
}

model DailyReportComment {
  id        String      @id @default(uuid())
  reportId  String
  report    DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  text      String
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model DailyReportKPI {
  id          String      @id @default(uuid())
  reportId    String
  report      DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  kpiCode     String      // Code from KPITemplate (e.g. "CALLS_MADE")
  value       Float       // Actual value
  goal        Float?      // Planned value (optional)
  comment     String?     // Optional comment
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([reportId, kpiCode])
}

model HelpRequest {
  id          String   @id @default(uuid())
  reportId    String
  report      DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  text        String
  link        String?
  assigneeId  String
  assignee    User @relation("HelpRequestsAssigned", fields: [assigneeId], references: [id])
  dueDate     DateTime
  priority    Priority @default(MEDIUM)
  status      HelpStatus @default(OPEN)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Activity {
  id          String   @id @default(uuid())
  source      String
  externalId  String?
  userId      String
  user        User @relation(fields: [userId], references: [id])
  reportId    String?
  report      DailyReport? @relation(fields: [reportId], references: [id])
  title       String?
  description String?
  startTime   DateTime?
  duration    Int?
  metadata    Json?
  createdAt   DateTime @default(now())
}

// --- Role Archetypes System (Job Roles, not Access Control) ---
// This is separate from the RBAC Role model above.
// These are work roles like "SDR", "Product Manager", "DevOps" etc.

enum RoleLevel {
  IC          // Individual Contributor
  TEAMLEAD    // Team Lead
  HEAD        // Head of Department
  CLEVEL      // C-Level (CTO, CMO, etc)
}

enum KPIDirection {
  HIGHER_BETTER    // Ð±Ñ–Ð»ÑŒÑˆÐµ ÐºÑ€Ð°Ñ‰Ðµ
  LOWER_BETTER     // Ð¼ÐµÐ½ÑˆÐµ ÐºÑ€Ð°Ñ‰Ðµ
  TARGET_VALUE     // Ñ†Ñ–Ð»ÑŒÐ¾Ð²Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½Ñ
}

enum KPIFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

// Department Archetype (not the org department, but the functional area template)
model DepartmentArchetype {
  id          String   @id @default(uuid())
  code        String   @unique // SALES, MKT, PRODENG, CS, OPS
  name        String   // "ÐŸÑ€Ð¾Ð´Ð°Ð¶Ñ–", "ÐœÐ°Ñ€ÐºÐµÑ‚Ð¸Ð½Ð³"
  description String?
  
  roles       RoleArchetype[]
  departments Department[] // Actual departments using this archetype
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("department_archetypes")
}

// Role Archetype (SDR, AE, PM, DevOps, etc)
model RoleArchetype {
  id                  String   @id @default(uuid())
  code                String   @unique // SALES_SDR, ENG_DEV, etc
  name                String   // "SDR / Ð›Ñ–Ð´Ð¾Ð³ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€"
  level               RoleLevel
  description         String?
  reportTemplate      Json?    // Structure of the daily report for this role
  
  // AI Context
  mission             String?  @db.Text
  typicalTasks        Json?    // ["Task 1", "Task 2"]
  antiPatterns        Json?    // ["Don't do X", "Don't do Y"]
  
  departmentArchetypeId String
  departmentArchetype   DepartmentArchetype @relation(fields: [departmentArchetypeId], references: [id])
  
  kpis                KPITemplate[]
  users               User[] @relation("UserRoleArchetype")
  jobRoles            JobRole[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("role_archetypes")
}

// KPI Template (template for a specific role archetype)
model KPITemplate {
  id                String   @id @default(uuid())
  code              String   @unique // LEADS_CREATED_DAILY, WIN_RATE, etc
  name              String   // "ÐÐ¾Ð²Ñ– Ð»Ñ–Ð´Ð¸ Ð·Ð° Ð´ÐµÐ½ÑŒ"
  description       String?
  unit              String   // "ÐºÑ–Ð»ÑŒÐºÑ–ÑÑ‚ÑŒ", "Ð³Ñ€Ð½", "%", etc
  direction         KPIDirection
  frequency         KPIFrequency @default(WEEKLY)
  
  roleArchetypeId   String
  roleArchetype     RoleArchetype @relation(fields: [roleArchetypeId], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("kpi_templates")
}

// --- My Day Feature ---

model DailyPlan {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation("UserDailyPlans", fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime @db.Date
  rawText   String   @db.Text // Original text from editor
  
  // Parsed data
  tasks     DailyTask[]
  metrics   DailyMetric[]
  
  // Load calculation
  loadStatus          LoadStatus @default(BALANCED)
  loadManuallySet     Boolean    @default(false)
  effectiveCapacity   Int?       // minutes
  totalLoad           Int?       // minutes
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, date])
  @@map("daily_plans")
}

model DailyTask {
  id              String   @id @default(uuid())
  planId          String
  plan            DailyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  type            TaskType
  title           String
  estimateMinutes Int      @default(0)
  plannedStart    DateTime?
  plannedEnd      DateTime?
  rawLine         String   // Original text line
  
  createdAt DateTime @default(now())
  
  @@map("daily_tasks")
}

model DailyMetric {
  id      String   @id @default(uuid())
  planId  String
  plan    DailyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  scope   MetricScope // YESTERDAY or TODAY_PLAN
  name    String
  value   Float
  comment String?
  
  createdAt DateTime @default(now())
  
  @@map("daily_metrics")
}

enum TaskType {
  BIG
  MEDIUM
  SMALL
}

enum MetricScope {
  YESTERDAY
  TODAY_PLAN
}

// --- 3 Blocks Feature ---

model ThreeBlocks {
  id              String   @id @default(uuid())
  userId          String
  date            DateTime @db.Date
  yesterdayTasks  String?  @db.Text
  yesterdayMetrics String? @db.Text
  todayPlan       String?  @db.Text
  helpNeeded      String?  @db.Text
  status          ThreeBlocksStatus   @default(DRAFT)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@index([userId, date])
  @@map("three_blocks")
}

enum ThreeBlocksStatus {
  DRAFT
  PUBLISHED
}

// --- AI Advisory Board System ---

// 1. Structure & Roles

model Team {
  id          String   @id @default(uuid())
  name        String
  description String?
  
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  deptId      String
  department  Department @relation(fields: [deptId], references: [id])
  
  managerId   String?
  // Manager relation is handled via User.teamId + User.roles or explicit logic
  // But for clarity we can link to a user who is the lead
  
  users       User[]
  goals       Goal[]   @relation("TeamGoals")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("teams")
}

model JobRole {
  id          String   @id @default(uuid())
  name        String   // "Sales Manager SMB"
  level       RoleLevel // JUNIOR, MIDDLE, SENIOR, LEAD
  
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Link to global archetype
  archetypeId String?
  archetype   RoleArchetype? @relation(fields: [archetypeId], references: [id])
  
  // Custom context for this specific company role
  mission     String?  @db.Text
  responsibilities Json? // ["Call leads", "Close deals"]
  
  users       User[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("job_roles")
}

// 2. Goals & Metrics

enum GoalLevel {
  COMPANY
  DEPARTMENT
  TEAM
  USER
}

model Goal {
  id          String   @id @default(uuid())
  title       String
  description String?
  level       GoalLevel
  period      String   // "2024-Q1", "2024-YEAR"
  
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Optional links based on level
  deptId      String?
  department  Department? @relation(fields: [deptId], references: [id])
  
  teamId      String?
  team        Team?    @relation("TeamGoals", fields: [teamId], references: [id])
  
  userId      String?
  user        User?    @relation("UserGoals", fields: [userId], references: [id])
  
  parentId    String?
  parent      Goal?    @relation("GoalHierarchy", fields: [parentId], references: [id])
  children    Goal[]   @relation("GoalHierarchy")
  
  metrics     Json?    // [{ name: "Revenue", target: 100000, current: 50000 }]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("goals")
}

// 3. Workday & Tasks (The Core)

model Workday {
  id              String   @id @default(uuid())
  date            DateTime @db.Date
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Plan Phase
  mainFocus       String?  @db.Text // "Ð“Ð¾Ð»Ð¾Ð²Ð½Ð¸Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð´Ð½Ñ"
  selfAssessment  Int?     // 1-10 scale of resource/confidence
  
  // Report Phase
  reportText      String?  @db.Text // "Ð©Ð¾ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð·Ñ€Ð¾Ð±Ð¸Ñ‚Ð¸"
  blockersText    String?  @db.Text // "Ð©Ð¾ Ð·Ð°Ð²Ð°Ð´Ð¸Ð»Ð¾"
  mood            Int?     // 1-5
  
  // Stats & Signals (Aggregated)
  dailyStats      Json?    // { planned: 5, completed: 3, focusMinutes: 120 }
  
  tasks           DayTask[]
  aiAdvice        AIAdvice[]
  integrationSummaries IntegrationSummary[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([userId, date])
  @@map("workdays")
}

enum DayTaskStatus {
  PLANNED
  IN_PROGRESS
  DONE
  CARRYOVER
  CANCELED
}

enum TaskSource {
  PLAN
  REPORT
}

model DayTask {
  id          String   @id @default(uuid())
  workdayId   String
  workday     Workday  @relation(fields: [workdayId], references: [id], onDelete: Cascade)
  
  rawText     String   @db.Text // Original input
  source      TaskSource @default(PLAN)
  
  // Structured Data (AI Enriched)
  title       String?
  outcome     String?  @db.Text
  steps       Json?    // ["Step 1", "Step 2"]
  dod         String?  // Definition of Done
  tags        Json?    // ["Sales", "Urgent"]
  priority    String?  // "A", "B", "C"
  
  status      DayTaskStatus @default(PLANNED)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("day_tasks")
}

// 4. AI & Analytics

enum AdviceType {
  EMPLOYEE_MENTOR
  MANAGER_DIGEST
  TASK_STRUCTURIZER
}

model AIAdvice {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  workdayId   String?
  workday     Workday? @relation(fields: [workdayId], references: [id])
  
  type        AdviceType
  content     Json     // The structured advice payload
  
  feedback    Int?     // User rating (1-5)
  feedbackText String?
  
  model       String?  // "gpt-4o"
  tokensIn    Int?
  tokensOut   Int?
  
  createdAt   DateTime @default(now())
  
  @@map("ai_advice")
}

model ManagerDigest {
  id          String   @id @default(uuid())
  managerId   String
  // No direct relation to User to avoid circular dependency hell, just store ID
  // Or optional relation if needed
  
  date        DateTime @db.Date
  content     Json     // { teamOverview: "...", risks: [], focus: [] }
  
  createdAt   DateTime @default(now())
  
  @@unique([managerId, date])
  @@map("manager_digests")
}

model WorkdaySummary {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date        DateTime @db.Date
  
  summary     String   @db.Text // Human-readable summary of the day
  signals     Json?    // { completedPct: 80, mood: 4, mainBlocker: "API" }
  
  createdAt   DateTime @default(now())
  
  @@unique([userId, date])
  @@map("workday_summaries")
}

model IntegrationSummary {
  id          String   @id @default(uuid())
  workdayId   String
  workday     Workday  @relation(fields: [workdayId], references: [id], onDelete: Cascade)
  
  source      String   // "yaware", "calendar"
  data        Json     // { activeMinutes: 300, meetings: 4 }
  
  createdAt   DateTime @default(now())
  
  @@map("integration_summaries")
}

// 5. Setup & Onboarding Tracking

model OrganizationSetup {
  id          String   @id @default(uuid())
  orgId       String   @unique
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Step completion tracking
  companyConfigured     Boolean @default(false)
  structureConfigured   Boolean @default(false)   // Departments & Teams
  rolesConfigured       Boolean @default(false)   // JobRoles created
  employeesConfigured   Boolean @default(false)   // >= 2 employees
  processConfigured     Boolean @default(false)   // Daily process settings
  goalsConfigured       Boolean @default(false)   // At least 1 goal
  
  // Wizard state
  orgWizardCompleted    Boolean @default(false)
  orgWizardSkipped      Boolean @default(false)
  orgCurrentStep        Int     @default(1)       // 1-5
  
  // Feature flags (derived from completion)
  aiMentorEnabled       Boolean @default(false)
  managerDigestEnabled  Boolean @default(false)
  taskStructurizerEnabled Boolean @default(true)  // Always available
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("organization_setup")
}

// --- Email System ---

enum EmailCategory {
  ACCESS
  ONBOARDING
  LEGAL
  MARKETING
}

model EmailTemplate {
  id            String        @id @default(uuid())
  code          String        @unique // REG_CONFIRM_EMAIL, AUTH_PASSWORD_RESET, etc.
  name          String
  description   String?
  category      EmailCategory
  critical      Boolean       @default(false)
  enabled       Boolean       @default(true)
  recipients    String[]      // ["All Roles", "Admin", etc.]
  triggers      String?       // "User registration", "Password reset", etc.
  variables     String[]      // ["user_name", "confirmation_link", etc.]
  
  // Translations (JSON for flexibility with future languages)
  templates     Json          // { "uk": { subject, body }, "en": { subject, body } }
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("email_templates")
}

model EmailLog {
  id          String   @id @default(uuid())
  templateId  String
  recipient   String
  status      String   // "sent", "failed", "queued"
  error       String?
  metadata    Json?
  
  sentAt      DateTime @default(now())
  
  @@index([recipient])
  @@index([templateId])
  @@index([sentAt])
  @@map("email_logs")
}

model Subscriber {
  id        String   @id @default(uuid())
  email     String   @unique
  status    String   @default("pending") // "confirmed", "pending", "unsubscribed"
  source    String?  // "landing_page", "invite", etc.
  language  Language @default(UK)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("subscribers")
}
