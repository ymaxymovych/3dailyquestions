generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Core Entities ---

model Organization {
  id             String          @id @default(uuid())
  name           String
  slug           String?         @unique @default(cuid())
  plan           String          @default("free")
  status         String          @default("active")
  maxUsers       Int             @default(5)
  maxProjects    Int             @default(10)
  timezone       String          @default("UTC")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  departments    Department[]
  users          User[]
  projects       Project[]
  tags           Tag[]
  kpiDefinitions KpiDefinition[]
  dailyReports   DailyReport[]
  domains        String[]        @default([]) // e.g. ["softserve.com", "google.com"]
  invites        Invite[]
}

model Invite {
  id          String   @id @default(uuid())
  email       String
  token       String   @unique
  
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  inviterId   String
  inviter     User     @relation("UserInvites", fields: [inviterId], references: [id])
  
  role        String?  // e.g. "EMPLOYEE", "MANAGER"
  
  expiresAt   DateTime
  status      InviteStatus @default(PENDING)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([email])
  @@index([token])
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

model Department {
  id        String   @id @default(uuid())
  name      String
  
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Link to archetype template (optional for custom departments)
  archetypeId String?
  archetype   DepartmentArchetype? @relation(fields: [archetypeId], references: [id])
  
  managerId String?
  hrId      String?
  
  users     User[]
  projects  Project[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("departments")
}

// Legacy Enum - Keeping for migration safety, but moving to Role model
enum LegacyRole {
  EMPLOYEE
  MANAGER
  HR
  ADMIN
  OWNER
}

enum Language {
  UK
  EN
}

enum UserStatus {
  ACTIVE
  PENDING
  BLOCKED
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  googleId     String?  @unique
  passwordHash String?
  fullName     String
  timezone     String   @default("UTC")
  language     Language @default(UK)
  status       UserStatus @default(ACTIVE)
  orgId        String
  org          Organization @relation(fields: [orgId], references: [id])
  deptId       String?
  department   Department? @relation(fields: [deptId], references: [id])
  
  // Roles & Access
  roles        UserRole[]
  
  // Work Role Archetype (job function, not access control)
  roleArchetypeId String?
  roleArchetype   RoleArchetype? @relation("UserRoleArchetype", fields: [roleArchetypeId], references: [id])
  
  // Soft Delete
  deletedAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  dailyReports DailyReport[]
  activities   Activity[]
  projectsOwned Project[]
  helpRequestsAssigned HelpRequest[] @relation("HelpRequestsAssigned")
  dailyReportReactions DailyReportReaction[]
  dailyReportComments  DailyReportComment[]
  dailyPlans           DailyPlan[]           @relation("UserDailyPlans")
  threeBlocks          ThreeBlocks[]

  // User Settings & Admin Module
  profile         UserProfile?
  preferences     UserPreferences?
  integrations    Integration[]
  kpis            UserKPI[]
  workdaySettings WorkdaySettings?
  artifacts       Artifact[]
  userProjects    UserProject[]
  sentInvites     Invite[]      @relation("UserInvites")
}

// --- Access Control (RBAC) ---

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "EMPLOYEE", "MANAGER", "ADMIN"
  description String?
  scopes      String[] // e.g., ["team.read", "project.create"]
  isSystem    Boolean  @default(false)
  
  users       UserRole[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  assignedBy String?
  createdAt  DateTime @default(now())
  
  @@unique([userId, roleId])
}

model AccessLog {
  id          String   @id @default(uuid())
  requesterId String
  targetId    String
  reason      String
  scopes      String[]
  grantedAt   DateTime @default(now())
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

// --- User Profile Layers ---

model UserProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  jobTitle    String?
  department  String?
  bio         String?
  avatarUrl   String?
  phone       String?
  
  // New fields
  resumeUrl       String?
  roleDescription String?
  
  updatedAt   DateTime @updatedAt
}

model Artifact {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        ArtifactType
  layer       ProfileLayer
  
  title       String
  content     String?  // Text content or URL
  metadata    Json?
  
  version     Int      @default(1)
  isCurrent   Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  createdBy   String?
}

enum ArtifactType {
  RESUME
  JOB_DESCRIPTION
  ROLE_DESCRIPTION
  HATS_LIST
  ONBOARDING_DOC
  OTHER
}

enum ProfileLayer {
  OFFICIAL
  ACTUAL
  INSTRUMENTAL
}

// --- Extended User Settings ---

model WorkdaySettings {
  id           String   @id @default(uuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  timezone     String   @default("Europe/Kyiv")
  start        String   @default("09:00")
  end          String   @default("18:00")
  breakMinutes Int      @default(60)
  workDays     Int[]    @default([1, 2, 3, 4, 5])
  
  updatedAt    DateTime @updatedAt
}

model UserPreferences {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  language              Language @default(UK)
  timezone              String   @default("Europe/Kyiv")
  workDayStart          String   @default("09:00")
  workDayEnd            String   @default("18:00")
  isAutoBookFocus       Boolean  @default(false)
  privacyAggregatedOnly Boolean  @default(true)
  useMinimalisticDesign Boolean  @default(false)
  updatedAt             DateTime @updatedAt
}

// --- Integrations ---

enum IntegrationType {
  YAWARE
  GMAIL
  CALENDAR
  JIRA
}

model Integration {
  id          String          @id @default(uuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        IntegrationType
  credentials Json?
  settings    Json?
  isEnabled   Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([userId, type])
}

// --- KPI System ---

enum KpiPeriod {
  DAY
  WEEK
  MONTH
}

enum KpiSource {
  MANUAL
  INTEGRATION
}

enum KpiStatus {
  ACTIVE
  PENDING
  ARCHIVED
}

model KpiDefinition {
  id          String   @id @default(uuid())
  name        String
  unit        String
  period      KpiPeriod @default(WEEK)
  source      KpiSource @default(MANUAL)
  
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id])
  
  isSystem    Boolean  @default(false)
  
  assignments UserKPI[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserKPI {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  definitionId String
  definition   KpiDefinition @relation(fields: [definitionId], references: [id])
  
  targetValue  Float
  status       KpiStatus @default(ACTIVE)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// --- Project System ---

enum ProjectStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
}

enum ProjectType {
  ONGOING
  ONE_TIME
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)
  type        ProjectType   @default(ONGOING)
  
  deadline    DateTime?
  
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id])
  deptId      String?
  department  Department? @relation(fields: [deptId], references: [id])
  ownerId     String
  owner       User @relation(fields: [ownerId], references: [id])
  
  userAssignments UserProject[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserProject {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  role        String?  // "Owner", "Member"
  isPinned    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  
  @@unique([userId, projectId])
}

model Tag {
  id          String   @id @default(uuid())
  name        String
  color       String   @default("#808080")
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([orgId, name])
}

// --- Daily Report ---

enum ReportStatus {
  DRAFT
  PUBLISHED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum HelpStatus {
  OPEN
  IN_PROGRESS
  DONE
  OVERDUE
}

enum ReportVisibility {
  PUBLIC
  TEAM
  PRIVATE
}

enum LoadStatus {
  BALANCED
  OVERLOADED
  UNDERLOADED
}

model DailyReport {
  id          String   @id @default(uuid())
  date        DateTime @db.Date
  userId      String
  user        User @relation(fields: [userId], references: [id])
  
  orgId       String?
  org         Organization? @relation(fields: [orgId], references: [id])
  
  yesterdayBig    Json?
  yesterdayMedium Json?
  yesterdaySmall  Json?
  yesterdayNote   String?
  coveragePct     Int?
  
  todayBig        Json?
  todayMedium     Json?
  todaySmall      Json?
  todayNote       String?
  
  helpRequests    HelpRequest[]
  
  mood            Int?
  wellbeing       String?
  moodComment     String?
  
  status          ReportStatus @default(DRAFT)
  publishedAt     DateTime?
  
  // Team View Fields
  visibility      ReportVisibility @default(TEAM)
  loadStatus      LoadStatus       @default(BALANCED)
  loadManuallySet Boolean          @default(false)
  
  reactions       DailyReportReaction[]
  comments        DailyReportComment[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  activities      Activity[]
  kpis            DailyReportKPI[]
  
  @@unique([userId, date])
  @@index([orgId])
  @@index([orgId, date])
}

model DailyReportReaction {
  id        String      @id @default(uuid())
  reportId  String
  report    DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  emoji     String      // "üëç", "üëè", "ü§ù", "üí°"
  
  createdAt DateTime    @default(now())
  
  @@unique([reportId, userId, emoji])
}

model DailyReportComment {
  id        String      @id @default(uuid())
  reportId  String
  report    DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  text      String
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model DailyReportKPI {
  id          String      @id @default(uuid())
  reportId    String
  report      DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  kpiCode     String      // Code from KPITemplate (e.g. "CALLS_MADE")
  value       Float       // Actual value
  goal        Float?      // Planned value (optional)
  comment     String?     // Optional comment
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([reportId, kpiCode])
}

model HelpRequest {
  id          String   @id @default(uuid())
  reportId    String
  report      DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  text        String
  link        String?
  assigneeId  String
  assignee    User @relation("HelpRequestsAssigned", fields: [assigneeId], references: [id])
  dueDate     DateTime
  priority    Priority @default(MEDIUM)
  status      HelpStatus @default(OPEN)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Activity {
  id          String   @id @default(uuid())
  source      String
  externalId  String?
  userId      String
  user        User @relation(fields: [userId], references: [id])
  reportId    String?
  report      DailyReport? @relation(fields: [reportId], references: [id])
  title       String?
  description String?
  startTime   DateTime?
  duration    Int?
  metadata    Json?
  createdAt   DateTime @default(now())
}

// --- Role Archetypes System (Job Roles, not Access Control) ---
// This is separate from the RBAC Role model above.
// These are work roles like "SDR", "Product Manager", "DevOps" etc.

enum RoleLevel {
  IC          // Individual Contributor
  TEAMLEAD    // Team Lead
  HEAD        // Head of Department
  CLEVEL      // C-Level (CTO, CMO, etc)
}

enum KPIDirection {
  HIGHER_BETTER    // –±—ñ–ª—å—à–µ –∫—Ä–∞—â–µ
  LOWER_BETTER     // –º–µ–Ω—à–µ –∫—Ä–∞—â–µ
  TARGET_VALUE     // —Ü—ñ–ª—å–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è
}

enum KPIFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

// Department Archetype (not the org department, but the functional area template)
model DepartmentArchetype {
  id          String   @id @default(uuid())
  code        String   @unique // SALES, MKT, PRODENG, CS, OPS
  name        String   // "–ü—Ä–æ–¥–∞–∂—ñ", "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥"
  description String?
  
  roles       RoleArchetype[]
  departments Department[] // Actual departments using this archetype
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("department_archetypes")
}

// Role Archetype (SDR, AE, PM, DevOps, etc)
model RoleArchetype {
  id                  String   @id @default(uuid())
  code                String   @unique // SALES_SDR, ENG_DEV, etc
  name                String   // "SDR / –õ—ñ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä"
  level               RoleLevel
  description         String?
  
  departmentArchetypeId String
  departmentArchetype   DepartmentArchetype @relation(fields: [departmentArchetypeId], references: [id])
  
  kpis                KPITemplate[]
  users               User[] @relation("UserRoleArchetype")
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("role_archetypes")
}

// KPI Template (template for a specific role archetype)
model KPITemplate {
  id                String   @id @default(uuid())
  code              String   @unique // LEADS_CREATED_DAILY, WIN_RATE, etc
  name              String   // "–ù–æ–≤—ñ –ª—ñ–¥–∏ –∑–∞ –¥–µ–Ω—å"
  description       String?
  unit              String   // "–∫—ñ–ª—å–∫—ñ—Å—Ç—å", "–≥—Ä–Ω", "%", etc
  direction         KPIDirection
  frequency         KPIFrequency @default(WEEKLY)
  
  roleArchetypeId   String
  roleArchetype     RoleArchetype @relation(fields: [roleArchetypeId], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("kpi_templates")
}

// --- My Day Feature ---

model DailyPlan {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation("UserDailyPlans", fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime @db.Date
  rawText   String   @db.Text // Original text from editor
  
  // Parsed data
  tasks     DailyTask[]
  metrics   DailyMetric[]
  
  // Load calculation
  loadStatus          LoadStatus @default(BALANCED)
  loadManuallySet     Boolean    @default(false)
  effectiveCapacity   Int?       // minutes
  totalLoad           Int?       // minutes
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, date])
  @@map("daily_plans")
}

model DailyTask {
  id              String   @id @default(uuid())
  planId          String
  plan            DailyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  type            TaskType
  title           String
  estimateMinutes Int      @default(0)
  plannedStart    DateTime?
  plannedEnd      DateTime?
  rawLine         String   // Original text line
  
  createdAt DateTime @default(now())
  
  @@map("daily_tasks")
}

model DailyMetric {
  id      String   @id @default(uuid())
  planId  String
  plan    DailyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  scope   MetricScope // YESTERDAY or TODAY_PLAN
  name    String
  value   Float
  comment String?
  
  createdAt DateTime @default(now())
  
  @@map("daily_metrics")
}

enum TaskType {
  BIG
  MEDIUM
  SMALL
}

enum MetricScope {
  YESTERDAY
  TODAY_PLAN
}

// --- 3 Blocks Feature ---

model ThreeBlocks {
  id              String   @id @default(uuid())
  userId          String
  date            DateTime @db.Date
  yesterdayTasks  String?  @db.Text
  yesterdayMetrics String? @db.Text
  todayPlan       String?  @db.Text
  helpNeeded      String?  @db.Text
  status          ThreeBlocksStatus   @default(DRAFT)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@index([userId, date])
  @@map("three_blocks")
}

enum ThreeBlocksStatus {
  DRAFT
  PUBLISHED
}
